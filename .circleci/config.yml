version: 2.1

parameters:
  run_integration_tests:
    type: boolean
    default: true
  run_update_image_snapshot:
    type: boolean
    default: false

executors:
  my-executor:
    docker:
      - image: circleci/node:latest-browsers

workflows:
  version: 2
  integration_tests:
    when: << pipeline.parameters.run_integration_tests >>
    jobs:
      - test
  update_image_snapshot:
    when: << pipeline.parameters.run_update_image_snapshot >>
    jobs:
      - update_image_snapshot

jobs:
  test:
    executor: my-executor
    steps:
      - checkout
      - run: sudo apt -qqy --no-install-recommends install -y fonts-takao-gothic fonts-takao-mincho && sudo dpkg-reconfigure --frontend noninteractive locales && sudo fc-cache -fv
      - run: echo ${CIRCLE_BRANCH}
      - run: node --version
      - run: yarn
      # いらないかも
      # - run: |
      #     if [$(git status --porcelain 2>/dev/null | grep "^??" | wc -l) -ge 1 ] ; then
      #       echo "exist untracked file"
      #     else 
      #       echo "no untracked file"
      #     fi
      - run: yarn run test:e2e-on-ci
      - run:
        name: on fail
        command: cat diffImagesURLs.txt | xargs node slack-notification.js
        when: on_fail

  # you can run that on command
  # curl -u {$CIRCLE_API_USER_TOKEN}: \
  #   -X POST \
  #   -H "Content-Type: application/json" \
  #   -d '{"branch":"develop","parameters":{"run_integration_tests":false,"run_update_image_snapshot":true}}' \
  #   https://circleci.com/api/v2/project/gh/tamaritamari/puppeteer-nuxt/pipeline

  update_image_snapshot:
    executor: my-executor
    steps:
      - checkout
      - run: echo "you are succeed trigger job by api"